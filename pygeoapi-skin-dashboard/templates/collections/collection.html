{% extends "_base.html" %}
{% block title %}{{ super() }} {{ data['title'] }} {% endblock %}
{% block crumbs %}{{ super() }}
/ <a href="../collections">Collections</a>
/ <a href="./{{ data['id'] }}">{{ data['title'] }}</a>
{% endblock %}

{% set tile = namespace(url="") %}


{% block extrahead %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
{% endblock %}

{% block body %}
    <style>
      .browse-link {
        font-size: 1.2em;
      }
    </style>
    <section id="collection">
      <div class="row">
        <div class="col-12">
          <h1>{{ data['title'] }}</h1>
          <p>{{ data['description'] }}</p>

        </div>
        <div class="col-md-4">
          <p>
            {% for kw in data['keywords'] %}
              <span class="badge badge-info mt-1">{{ kw }}</span>
            {% endfor %}
          </p>
        {% if data['itemType'] == 'feature' or data['itemType'] == 'record'  %}
        <h3>Browse</h3>
        <ul class="px-4">
          <li>
            <div>
              <a title="Browse Items" class="browse-link"
              href="{{ config['server']['url'] }}/collections/{{ data['id'] }}/items">
              Browse Items of {{ data['title'] }}</a>
            </div>
          </li>
        {% for provider in config['resources'][data['id']]['providers'] %}
        {% if 'tile' in provider['type'] %}
        {% set tile.url = data["collections_path"] + "/" + data["id"] + "/tiles/WebMercatorQuad/{z}/{y}/{x}?f=pbf" %}
          <li>
            <div>
              <a title="Browse Tiles" class="browse-link"
              href="{{ config['server']['url'] }}/collections/{{ data['id'] }}/tiles">
              Browse Tiles of {{ data['title'] }}</a>
            </div>
          </li>
        {% endif %}
        {% endfor %}
        {% endif  %}
        </ul>
        <h3>Links</h3>
        <ul class="px-4">
          {% for link in data['links'] %}
          {% if link['type'] == 'text/html' and link['rel'] != 'self' and link['rel'] != 'root' %}
              <li>
                <a title="{{ link['rel'] }}" class="browse-link" href="{{ link['href'] }}">
                <span>{{ link['title'] }}</span>
                </a>
              </li>
          {% endif %}
          {% endfor %}
        </ul>
        </div>
        <div class="col-md-8">
          <div class="card shadow mb-4">
            <!-- Card Body -->
            <div>
              <div id="collection-map" style="height: 600px"></div>
            </div>
          </div>
        </div>        
      </div>
    </section>

{% endblock %}

{% block extrafoot %}
    <script>

    var map = L.map('collection-map').setView([{{ 0 }}, {{ 0 }}], 1);
    map.addLayer(new L.TileLayer(
      '{{ config['server']['map']['url'] }}', {
        maxZoom: 18,
        minZoom: 1,
        attribution: '{{ config['server']['map']['attribution'] }}'
      }
    ));

    {% if tile.url == "" %}
    var bbox_layer = L.polygon([
      ['{{ data['extent']['spatial']['bbox'][0][1] }}', '{{ data['extent']['spatial']['bbox'][0][0] }}'],
      ['{{ data['extent']['spatial']['bbox'][0][3] }}', '{{ data['extent']['spatial']['bbox'][0][0] }}'],
      ['{{ data['extent']['spatial']['bbox'][0][3] }}', '{{ data['extent']['spatial']['bbox'][0][2] }}'],
      ['{{ data['extent']['spatial']['bbox'][0][1] }}', '{{ data['extent']['spatial']['bbox'][0][2] }}']
    ], {
      color: "#1B335F"
    });

    map.addLayer(bbox_layer);
    map.fitBounds(bbox_layer.getBounds(), {maxZoom: 10});
    {% else %}
        url = "{{ tile.url }}";
        var VectorTileOptions = {
            interactive: true,
            maxZoom: 10,
            indexMaxZoom: 5,
            getFeatureId: function(feat) {
                return feat.properties.id || feat.properties.fid || feat.properties.uri;
            },
            vectorTileLayerStyles: {
                {{ data["id"] }}: function(properties, zoom) {
                    return {
                        color: '#1B335F',
                        fillColor: '#1B335F',
                        weight: 0.25 + (zoom / 4),
                        fill: true,
                        fillOpacity: 0.1,
                        radius: Math.min(zoom / 4, 4) 
                    }
                }
            }
        };

        var highlight;
        var clearHighlight = function() {
            if (highlight) {
                tilesPbfLayer.resetFeatureStyle(highlight);
            }
            highlight = null;
        };

        var tilesPbfLayer = L.vectorGrid.protobuf(url, VectorTileOptions)
            .on('click', function(e) { // The .on method attaches an event handler
                console.log(e);
                var uri = e.layer.properties.uri;
                L.popup()
                    .setContent(`<a href="${uri}">${uri}</a>`)
                    .setLatLng(e.latlng)
                    .openOn(map);

                clearHighlight();
                highlight = e.layer.properties.id || e.layer.properties.fid || e.layer.properties.uri;
                tilesPbfLayer.setFeatureStyle(highlight, {
                    weight: 2 + e.layer.options.weight * 2,
                    color: '#E6000B',
                    fillColor: '#E6000B',
                    fill: true,
                    radius: 4,
                    fillOpacity: 0.75
                });

                L.DomEvent.stop(e);
            })
            .addTo(map);

        map.on('click', clearHighlight);
        bounds = L.latLngBounds([
            [
                {{ data['extent']['spatial']['bbox'][0][1] }},
                {{ data['extent']['spatial']['bbox'][0][0] }},
            ],[
                {{ data['extent']['spatial']['bbox'][0][3] }},
                {{ data['extent']['spatial']['bbox'][0][2] }},
            ]
        ]);
        map.fitBounds(bounds);
    {% endif %}
    </script>
{% endblock %}
